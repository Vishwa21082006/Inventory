<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sidebar-bg: #1e1e2d; --accent-red: #ff3b30; --bg-light: #f8f9fc;
            --text-dark: #2d3748; --text-grey: #718096;
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 240px; background: var(--sidebar-bg); color: white; padding: 24px 16px; flex-shrink: 0; }
        .logo { font-size: 1.6rem; font-weight: 700; margin-bottom: 48px; display: flex; align-items: center; gap: 12px; }
        .logo i { color: var(--accent-red); }
        .menu-item { padding: 12px 16px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 14px; color: #cbd5e0; transition: 0.2s; position: relative; }
        .menu-item:hover, .menu-item.active { background: var(--accent-red); color: white; }

        .badge-count {
            background-color: #ff3b30; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem;
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; font-weight: bold;
        }
        .menu-item.active .badge-count { background-color: white; color: var(--accent-red); }

        /* Main Content */
        .main-content { flex: 1; padding: 24px 32px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; flex-shrink: 0; }
        .search-bar { position: relative; width: 350px; }
        .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid #e2e8f0; outline: none; font-size: 0.9rem; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-grey); }

        .admin-profile { display: flex; gap: 16px; align-items: center; cursor: pointer; position: relative; padding: 8px 12px; border-radius: 8px; transition: 0.2s; }
        .admin-profile:hover { background: #edf2f7; }

        /* Settings Page Grid CSS */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 10px; }
        .setting-card { background: white; padding: 32px 24px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 16px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Inter', sans-serif; text-decoration: none;}
        .setting-card:hover { border-color: #cbd5e0; transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .setting-card i { font-size: 2.2rem; }
        .setting-card h4 { margin: 0; color: #2d3748; font-size: 1.15rem; font-weight: 700; }
        .setting-card p { margin: 0; color: #718096; font-size: 0.9rem; line-height: 1.4; }
        .logout-card { border-color: #fed7d7; width: 100%; }
        .logout-card:hover { border-color: #feb2b2; background: #fff5f5; }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 3fr 1.1fr; gap: 24px; flex: 1; min-height: 0; }
        .sales-activity-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 16px; }
        .stat-card { background: white; padding: 18px 14px; border-radius: 12px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.06); }
        .stat-card h3 { font-size: 1.9rem; margin: 6px 0 4px; font-weight: 700; }
        .stat-card p { font-size: 0.72rem; color: var(--text-grey); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }

        .panel { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.06); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid #edf2f7; }
        .panel-header h4 { margin: 0; font-size: 1.02rem; font-weight: 600; }

        .snap-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; font-size: 0.88rem; border-bottom: 1px solid #f7fafc; }
        .snap-row .val { font-weight: 600; }
        .snapshot-actions { display: flex; gap: 12px; margin-top: 12px; justify-content: center; }
        .btn-snapshot { padding: 7px 14px; font-size: 0.82rem; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-low-stock { background: #fed7d7; color: #9b2c2c; }
        .btn-pending { background: #bee3f8; color: #2b6cb0; }

        .top-perf-container { display: flex; gap: 24px; }
        .top-list { flex: 1.4; }
        .top-chart { flex: 0.6; height: 160px; }
        .list-item { display: flex; align-items: center; gap: 12px; padding: 9px 0; border-bottom: 1px solid #edf2f7; }
        .list-item i { width: 36px; height: 36px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; }
        .item-info h5 { margin: 0; font-size: 0.9rem; font-weight: 600; }
        .item-info span { font-size: 0.76rem; color: var(--text-grey); }

        /* Dark Card */
        .dark-card { background: #2d3748; color: white; border-radius: 12px; padding: 20px; height: 100%; display: flex; flex-direction: column; box-shadow: 0 5px 16px rgba(0,0,0,0.22); }
        .dark-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 12px; margin-bottom: 16px; }
        .inv-metrics { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .inv-metric span { font-size: 0.7rem; color: #cbd5e0; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; display: block; }
        .inv-metric h2 { margin: 0; font-size: 2rem; font-weight: 700; }
        .sold-box { background: rgba(255,255,255,0.07); border-radius: 10px; padding: 20px 16px; text-align: center; }
        .sold-box h2 { margin: 0; font-size: 2.6rem; color: #60a5fa; font-weight: 700; }
        .sold-box p { margin: 6px 0 0; color: #cbd5e0; font-size: 0.82rem; }

        /* Tables & Inputs */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.06); }
        th { background: #f8fafc; padding: 12px 14px; text-align: left; color: #4a5568; font-size: 0.84rem; font-weight: 600; }
        td { padding: 12px 14px; border-bottom: 1px solid #edf2f7; font-size: 0.88rem; }
        .status-badge { padding: 4px 10px; border-radius: 999px; font-size: 0.76rem; font-weight: 600; }

        .status-Ordered { background: #fff7ed; color: #c2410c; }
        .status-Received { background: #f0fdf4; color: #15803d; }
        .status-Shipped { background: #eff6ff; color: #1d4ed8; }
        .status-Delivered { background: #f0fdf4; color: #15803d; }
        .status-Returned { background: #fef2f2; color: #b91c1c; }

        .btn-update { background: var(--accent-red); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.84rem; }
        .qty-input { width: 70px; padding: 6px; text-align: center; border: 1px solid #e2e8f0; border-radius: 6px; font-weight: 700; color: #2d3748; }
        .filter-select { padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px; outline: none; font-size: 0.9rem; color: #4a5568; }

        /* Utils */
        .view-section { display: none; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; padding: 25px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #718096; }
        .modal-list-item { padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }

        /* PO Form */
        .po-form-group { margin-bottom: 15px; }
        .po-form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #4a5568; }
        .po-select, .po-input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff; }
        .btn-po { width: 100%; padding: 10px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; }

        #toast { visibility: hidden; background: #2d3748; color: white; padding: 12px 22px; border-radius: 10px; position: fixed; bottom: 32px; right: 32px; z-index: 999; opacity: 0; transition: all 0.4s; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
        #toast.show { visibility: visible; opacity: 1; bottom: 48px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><i class="fas fa-boxes"></i> Inventory</div>
    <div class="menu-item active" onclick="switchView('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard</div>
    <div class="menu-item" onclick="switchView('inventory', this)"><i class="fas fa-tshirt"></i> Inventory</div>
    <div class="menu-item" id="menu-sales" onclick="switchView('sales', this)">
        <i class="fas fa-shopping-cart"></i> Sales
        <span class="badge-count" id="badge-sales">0</span>
    </div>
    <div class="menu-item" id="menu-requests" onclick="switchView('requests', this)">
        <i class="fas fa-undo"></i> Returns
        <span class="badge-count" id="badge-returns">0</span>
    </div>
</div>

<div class="main-content">
    <div class="header">
        <h2>Admin Dashboard</h2>
        
        <div class="search-bar" id="topSearchBar" style="visibility: hidden;">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search orders, customers or dates..." onkeyup="handleSearch()">
        </div>

        <div class="admin-profile" onclick="switchView('settings')">
            <div style="display:flex; gap:8px; align-items:center;">
                <i class="fas fa-user-shield" style="color:#718096; font-size:1.1rem;"></i>
                <span style="font-weight:600; color:#2d3748;" id="display-admin-name">Admin</span>
            </div>
        </div>
    </div>

    <div id="settings-view" class="view-section">
        <h3 style="margin-bottom:20px; font-size: 1.4rem;">Admin Settings</h3>
        <div class="settings-grid">
            
            <div class="setting-card" onclick="document.getElementById('passwordModal').style.display='flex'">
                <i class="fas fa-key" style="color: #3182ce;"></i>
                <h4>Change Password</h4>
                <p>Update your administrator login credentials securely.</p>
            </div>

            <div class="setting-card" onclick="document.getElementById('nameModal').style.display='flex'">
                <i class="fas fa-id-badge" style="color: #48bb78;"></i>
                <h4>Set Admin Name</h4>
                <p>Customize the display name for your admin account.</p>
            </div>

            <div class="setting-card" onclick="switchView('staff')">
                <i class="fas fa-users-cog" style="color: #805ad5;"></i>
                <h4>Manage Staff</h4>
                <p>Add, review, or remove sub-admin staff accounts.</p>
            </div>

            <form action="/logout" method="post" style="display: contents;">
                <button type="submit" class="setting-card logout-card">
                    <i class="fas fa-sign-out-alt" style="color: #e53e3e;"></i>
                    <h4 style="color: #e53e3e;">Logout</h4>
                    <p style="color: #e53e3e;">Securely terminate your current session.</p>
                </button>
            </form>

        </div>
    </div>

    <div id="dashboard-view" class="view-section active">
        <div class="dashboard-grid">
            <div class="sales-activity-row">
                <div class="stat-card"><i class="fas fa-box" style="color:#4299e1;"></i><h3 id="d-total-stock">0</h3><p>Stock Qty</p></div>
                <div class="stat-card"><i class="fas fa-truck" style="color:#ed8936;"></i><h3 id="d-pending">0</h3><p>To Ship</p></div>
                <div class="stat-card"><i class="fas fa-check-circle" style="color:#48bb78;"></i><h3 id="d-delivered">0</h3><p>Delivered</p></div>
                <div class="stat-card"><i class="fas fa-dollar-sign" style="color:#f56565;"></i><h3 id="d-revenue">$0</h3><p>Revenue</p></div>
            </div>

            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="panel">
                    <div class="panel-header"><h4>Product Snapshot</h4></div>
                    <div class="snap-row"><div>Low Stock Alerts</div><span class="val" id="low-stock-count" style="color:#f56565;">0</span></div>
                    <div class="snap-row"><div>Total Products</div><span class="val" id="total-groups">0</span></div>
                    <div class="snap-row"><div>Pending / Processing</div><span class="val" id="unconfirmed-count">0</span></div>
                    <div class="snapshot-actions">
                        <button class="btn-snapshot btn-low-stock" onclick="showLowStockModal()">View Low Stock</button>
                        <button class="btn-snapshot btn-pending" onclick="showPendingOrdersModal()">View Pending</button>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header"><h4>Top Performing Products</h4></div>
                    <div class="top-perf-container">
                        <div class="top-list" id="top-selling-list"></div>
                        <div class="top-chart"><canvas id="topSellingChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div>
                <div class="dark-card">
                    <div class="dark-header"><h4>Inventory Overview</h4></div>
                    <div class="inv-metrics">
                        <div class="inv-metric"><span>IN HAND</span><h2 id="inv-in-hand">0</h2></div>
                        <div class="inv-metric" style="text-align:right;"><span>TO RECEIVE</span><h2 id="inv-to-receive">0</h2></div>
                    </div>
                    <div class="sold-box"><h2 id="total-qty-ordered">0</h2><p>Units Sold (Delivered)</p></div>
                    <div style="text-align:center; font-size:0.76rem; color:#a0aec0; margin-top:10px;">Updated <span id="last-updated">just now</span></div>
                    <div style="margin-top: auto; padding-top: 20px;">
                        <button onclick="openPOModal()" style="width: 100%; background: #4fd1c5; color: #1a202c; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-truck-loading"></i> Manage Purchase Orders
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory-view" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
            <h3 style="margin:0;">Manage Inventory</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-update" style="background:#e53e3e; padding:8px 16px; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="openRemoveProductModal()">
                    <i class="fas fa-trash"></i> Remove Product
                </button>
                <button class="btn-update" style="background:#48bb78; padding:8px 16px; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        </div>
        <table><thead><tr><th>ID</th><th>Image</th><th>Product</th><th>Price</th><th>Available (Live)</th><th>Stock (Target)</th><th>Action</th></tr></thead><tbody id="inventory-table-body"></tbody></table>
    </div>

    <div id="sales-view" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Sales Orders</h3>
            <div style="display:flex; gap:10px;">
                <input type="date" id="salesDateFilter" class="filter-select" onchange="filterSales()">
                <select id="salesFilter" class="filter-select" onchange="filterSales()">
                    <option value="All">All Statuses</option>
                    <option value="Ordered">Ordered</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Returned">Returned</option>
                </select>
            </div>
        </div>
        <table><thead><tr><th>ID</th><th>Customer</th><th>Orders</th><th>Total</th><th>Status</th><th>Date</th><th>Action</th></tr></thead><tbody id="orders-table-body"></tbody></table>
    </div>

    <div id="requests-view" class="view-section">
        <h3 style="margin-bottom:20px;">Return Requests</h3>
        <table><thead><tr><th>ID</th><th>Reason</th><th>Action</th></tr></thead><tbody id="requests-table-body"></tbody></table>
    </div>

    <div id="staff-view" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Manage Staff</h3>
            <button class="btn-update" style="background:#3182ce; padding:8px 16px; display:flex; align-items:center; gap:8px;" onclick="document.getElementById('addStaffModal').style.display='flex'">
                <i class="fas fa-user-plus"></i> Add Staff
            </button>
        </div>
        <table>
            <thead><tr><th>ID</th><th>Full Name</th><th>Username</th><th>Role</th><th>Action</th></tr></thead>
            <tbody id="staff-table-body"></tbody>
        </table>
    </div>
</div>

<div id="addProductModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header"><h3>Add New Product</h3><span class="modal-close" onclick="closeModal('addProductModal')">×</span></div>
        <form id="addProductForm" onsubmit="submitNewProduct(event)">
            <div class="po-form-group">
                <label>Product Name</label>
                <input type="text" id="add-name" class="po-input" placeholder="e.g. Leather Jacket" required>
            </div>
            <div class="po-form-group">
                <label>Category / SKU (e.g. JKT)</label>
                <input type="text" id="add-sku" class="po-input" placeholder="e.g. JKT" required>
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="po-form-group" style="flex: 1;">
                    <label>Price ($)</label>
                    <input type="number" id="add-price" step="0.01" class="po-input" placeholder="0.00" required>
                </div>
                <div class="po-form-group" style="flex: 1;">
                    <label>Initial Stock</label>
                    <input type="number" id="add-stock" class="po-input" placeholder="0" required>
                </div>
                <div class="po-form-group" style="flex: 1;">
                    <label>Target Stock</label>
                    <input type="number" id="add-target" class="po-input" placeholder="100" required>
                </div>
            </div>
            <div class="po-form-group">
                <label>Product Image (Optional)</label>
                <input type="file" id="add-image" accept="image/*" class="po-input">
            </div>
            <button type="submit" class="btn-po" style="background:#48bb78; margin-top: 10px;">Save Product</button>
        </form>
    </div>
</div>

<div id="removeProductModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header"><h3><i class="fas fa-trash"></i> Remove Product</h3><span class="modal-close" onclick="closeModal('removeProductModal')">×</span></div>
        <div class="po-form-group">
            <label>Select Product to Delete</label>
            <select id="removeProductSelect" class="po-select"></select>
        </div>
        <button onclick="submitRemoveProduct()" class="btn-po" style="background:#e53e3e;">Delete Product</button>
    </div>
</div>

<div id="poModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Manage Supplier Orders</h3><span class="modal-close" onclick="closeModal('poModal')">×</span></div>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <div style="background: #f8fafc; padding: 15px; border-radius: 10px;">
                <h4 style="margin-bottom: 15px;">Create New Order</h4>
                <form action="/admin/po/create" method="post">
                    <div class="po-form-group"><label>Select Product</label><select id="poProductSelect" name="productId" class="po-select" required></select></div>
                    <div class="po-form-group"><label>Quantity</label><input type="number" name="quantity" class="po-input" placeholder="e.g. 50" required min="1"></div>
                    <button type="submit" class="btn-po">Place Order</button>
                </form>
            </div>
            <div>
                <h4 style="margin-bottom: 15px;">Order History</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>ID</th><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody id="po-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header"><h3><i class="fas fa-key"></i> Change Password</h3><span class="modal-close" onclick="closeModal('passwordModal')">×</span></div>
        <form id="passwordForm" onsubmit="submitPasswordChange(event)">
            <div class="po-form-group">
                <label>Current Password</label>
                <input type="password" id="old-pwd" class="po-input" required>
            </div>
            <div class="po-form-group">
                <label>New Password</label>
                <input type="password" id="new-pwd" class="po-input" required>
            </div>
            <button type="submit" class="btn-po" style="background:#3182ce;">Update Password</button>
        </form>
    </div>
</div>

<div id="nameModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header"><h3><i class="fas fa-id-badge"></i> Set Admin Name</h3><span class="modal-close" onclick="closeModal('nameModal')">×</span></div>
        <form id="nameForm" onsubmit="submitAdminName(event)">
            <div class="po-form-group">
                <label>New Display Name</label>
                <input type="text" id="new-admin-name" class="po-input" placeholder="e.g. Super Admin" required>
            </div>
            <button type="submit" class="btn-po" style="background:#48bb78;">Save Name</button>
        </form>
    </div>
</div>

<div id="addStaffModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header"><h3><i class="fas fa-user-plus"></i> Add New Staff</h3><span class="modal-close" onclick="closeModal('addStaffModal')">×</span></div>
        <form id="addStaffForm" onsubmit="submitNewStaff(event)">
            <div class="po-form-group">
                <label>Full Name</label>
                <input type="text" id="staff-name" class="po-input" placeholder="Jane Doe" required>
            </div>
            <div class="po-form-group">
                <label>Username</label>
                <input type="text" id="staff-user" class="po-input" placeholder="janedoe123" required>
            </div>
            <div class="po-form-group">
                <label>Temporary Password</label>
                <input type="password" id="staff-pass" class="po-input" placeholder="Create a strong password" required>
            </div>
            <button type="submit" class="btn-po" style="background:#3182ce;">Create Admin Account</button>
        </form>
    </div>
</div>

<div id="lowStockModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Low Stock Products</h3><span class="modal-close" onclick="closeModal('lowStockModal')">×</span></div><div id="lowStockList"></div></div></div>
<div id="pendingOrdersModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Pending Orders</h3><span class="modal-close" onclick="closeModal('pendingOrdersModal')">×</span></div><div id="pendingOrdersList"></div></div></div>
<div id="toast">Msg</div>

<script>
let allProducts = [];
let allOrders = [];
let prevOrderCount = 0;
let prevReturnCount = 0;
let isFirstLoad = true;

window.onload = () => { refreshAll(); setInterval(refreshAll, 5000); };

function refreshAll() {
    const now = new Date();
    document.getElementById('last-updated').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    Promise.all([
        fetch('/products').then(r => r.json()),
        fetch('/orders/pending').then(r => r.json()),
        fetch('/api/users/staff').then(r => r.json())
    ]).then(([products, orders, staff]) => {
        allProducts = products;
        allOrders = orders;
        checkPopups(orders);
        renderDashboard(products, orders);
        renderStaff(staff); 

        const newOrdersCount = orders.filter(o => o.trackingStatus === 'Ordered').length;
        const returnReqCount = orders.filter(o => o.trackingStatus === 'Return Requested').length;
        updateBadge('badge-sales', newOrdersCount);
        updateBadge('badge-returns', returnReqCount);

        const activeEl = document.activeElement;
        const isTypingInventory = activeEl && activeEl.classList.contains('qty-input');
        const isTypingSearch = document.getElementById('searchInput').value !== '';
        
        const isPickingDateInTable = activeEl && activeEl.type === 'date' && activeEl.id && activeEl.id.startsWith('date-');

        if (!isTypingInventory && !isTypingSearch) renderInventory(products);
        if (!isTypingSearch && !isPickingDateInTable) filterSales();

        renderRequests(orders);
    }).catch(err => console.error(err));
}

function updateBadge(id, count) {
    const badge = document.getElementById(id);
    if(count > 0) { badge.innerText = count; badge.style.display = 'block'; }
    else { badge.style.display = 'none'; }
}

function openPOModal() {
    const select = document.getElementById('poProductSelect');
    select.innerHTML = '<option value="" disabled selected>Choose a product...</option>';
    
    allProducts.forEach(p => {
        const target = p.targetStock || 100;
        select.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.stockQuantity} / Target: ${target})</option>`;
    });

    fetch('/admin/api/pos').then(r => r.json()).then(pos => {
        const tbody = document.getElementById('po-table-body');
        tbody.innerHTML = '';
        pos.sort((a,b) => b.id - a.id).forEach(po => {
            let action = po.status === 'ORDERED' ?
                `<form action="/admin/po/receive/${po.id}" method="post"><button type="submit" style="padding:5px 10px; background:#38a169; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Receive</button></form>` :
                '<span style="color:#718096; font-size:0.8rem;">Completed</span>';
            tbody.innerHTML += `<tr><td>#${po.id}</td><td>${po.product.name}</td><td>${po.quantity}</td><td><span class="status-badge status-${po.status}">${po.status}</span></td><td>${action}</td></tr>`;
        });
    });
    document.getElementById('poModal').style.display = 'flex';
}

function openAddProductModal() {
    document.getElementById('addProductForm').reset();
    document.getElementById('addProductModal').style.display = 'flex';
}

function submitNewProduct(event) {
    event.preventDefault(); 

    const newProduct = {
        name: document.getElementById('add-name').value,
        skuCode: document.getElementById('add-sku').value,
        price: parseFloat(document.getElementById('add-price').value),
        stockQuantity: parseInt(document.getElementById('add-stock').value),
        targetStock: parseInt(document.getElementById('add-target').value)
    };

    fetch('/products/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newProduct)
    })
    .then(res => res.json())
    .then(savedProduct => {
        const fileInput = document.getElementById('add-image');
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            
            return fetch(`/products/${savedProduct.id}/upload-image`, {
                method: 'POST',
                body: formData
            });
        }
    })
    .then(() => {
        showToast("New Product Added!");
        closeModal('addProductModal');
        refreshAll(); 
    })
    .catch(err => {
        console.error(err);
        showToast("Error adding product.");
    });
}

function openRemoveProductModal() {
    const select = document.getElementById('removeProductSelect');
    select.innerHTML = '<option value="" disabled selected>Choose a product...</option>';
    
    allProducts.forEach(p => {
        select.innerHTML += `<option value="${p.id}">#${p.id} - ${p.name}</option>`;
    });
    
    document.getElementById('removeProductModal').style.display = 'flex';
}

function submitRemoveProduct() {
    const id = document.getElementById('removeProductSelect').value;
    if (!id) return showToast("Please select a product!");
    
    if (!confirm("Are you sure? This will permanently delete the product from the database.")) return;

    fetch(`/products/${id}`, {
        method: 'DELETE'
    })
    .then(async res => {
        const msg = await res.text();
        if (res.ok) {
            showToast("Product successfully removed!");
            closeModal('removeProductModal');
            refreshAll(); 
        } else {
            showToast(msg);
        }
    })
    .catch(err => showToast("Network error occurred"));
}

function checkPopups(orders) {
    const currentOrders = orders.length;
    const currentReturns = orders.filter(o => o.trackingStatus === 'Return Requested').length;
    if (!isFirstLoad) {
        if (currentOrders > prevOrderCount) showToast("New Order Received!");
        if (currentReturns > prevReturnCount) showToast("Alert: New Return Request!");
    }
    prevOrderCount = currentOrders; prevReturnCount = currentReturns; isFirstLoad = false;
}

function handleSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const activeView = document.querySelector('.view-section.active').id;
    if (activeView === 'inventory-view') renderInventory(allProducts.filter(p => p.name.toLowerCase().includes(query)));
    else if (activeView === 'sales-view') renderSales(allOrders.filter(o => {
        const name = (o.customer?.fullName || o.customer?.username || 'Guest').toLowerCase();
        const id = o.id.toString();
        let matches = name.includes(query) || id.includes(query);

        if (o.orderDate) {
            const datePart = o.orderDate.split('T')[0];               
            const reversed = datePart.split('-').reverse().join('-'); 
            const slashed = reversed.replace(/-/g, '/');              
            
            if (datePart.includes(query) || reversed.includes(query) || slashed.includes(query)) {
                matches = true;
            }
        }
        
        return matches;
    }));
}

function filterSales() {
    const status = document.getElementById('salesFilter').value;
    const date = document.getElementById('salesDateFilter').value;
    let filtered = allOrders;

    if(status !== 'All') {
        filtered = filtered.filter(o => (o.trackingStatus || 'Ordered') === status);
    }
    
    if(date) {
        filtered = filtered.filter(o => {
            const ordDate = o.orderDate ? o.orderDate.split('T')[0] : '';
            const delDate = o.deliveryDate ? o.deliveryDate.split('T')[0] : '';
            return ordDate === date || delDate === date;
        });
    }
    
    renderSales(filtered);
}

function renderDashboard(products, orders) {
    const totalStock = products.reduce((s,p)=>s + (p.stockQuantity||0), 0);
    const pending = orders.filter(o => ['Ordered','Shipped'].includes(o.trackingStatus)).length;
    const delivered = orders.filter(o => o.trackingStatus === 'Delivered').length;
    const revenue = orders.filter(o => o.trackingStatus !== 'Returned').reduce((s,o)=>s + (o.totalAmount||0), 0);

    document.getElementById('d-total-stock').innerText = totalStock.toLocaleString();
    document.getElementById('d-pending').innerText = pending;
    document.getElementById('d-delivered').innerText = delivered;
    document.getElementById('d-revenue').innerText = "$" + revenue.toLocaleString();

    const lowStockItems = products.filter(p => p.stockQuantity < ((p.targetStock || 100) * 0.10));
    document.getElementById('low-stock-count').innerText = lowStockItems.length;
    document.getElementById('total-groups').innerText = products.length;
    document.getElementById('unconfirmed-count').innerText = pending;

    document.getElementById('inv-in-hand').innerText = totalStock.toLocaleString();
    const toReceive = products.reduce((sum, p) => (p.stockQuantity < ((p.targetStock || 100) * 0.50)) ? sum + Math.floor((p.targetStock || 100) * 0.50) : sum, 0);
    document.getElementById('inv-to-receive').innerText = toReceive;

    const sold = orders.filter(o => o.trackingStatus === 'Delivered').reduce((sum,o) => sum + (o.items||[]).reduce((s,i)=>s+(i.quantity||0),0), 0);
    document.getElementById('total-qty-ordered').innerText = sold.toLocaleString();

    const map = {};
    orders.forEach(o => { if(o.trackingStatus !== 'Returned') (o.items||[]).forEach(i => map[i.product.name] = (map[i.product.name]||0) + i.quantity); });
    const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,4);

    const list = document.getElementById('top-selling-list');
    list.innerHTML = '';
    top.forEach(([name,qty]) => list.innerHTML += `<div class="list-item"><i class="fas fa-tshirt"></i><div class="item-info"><h5>${name}</h5><span>${qty} sold</span></div></div>`);
    renderTopChart(top);
}

let topChartInst;
function renderTopChart(top) {
    const ctx = document.getElementById('topSellingChart').getContext('2d');
    if (topChartInst) topChartInst.destroy();
    topChartInst = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: top.map(t => t[0]), datasets: [{ data: top.map(t => t[1]), backgroundColor: ['#f56565','#4299e1','#48bb78','#ed8936'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
    });
}

function showLowStockModal() {
    const low = allProducts.filter(p => p.stockQuantity < ((p.targetStock || 100) * 0.10));
    const el = document.getElementById('lowStockList');
    el.innerHTML = low.length ? low.map(p => `<div class="modal-list-item"><strong>${p.name}</strong> - Available: <span style="color:red">${p.stockQuantity}</span></div>`).join('') : '<p style="text-align:center;color:#888;">No low stock items.</p>';
    document.getElementById('lowStockModal').style.display = 'flex';
}
function showPendingOrdersModal() {
    const pending = allOrders.filter(o => ['Ordered','Shipped'].includes(o.trackingStatus));
    const el = document.getElementById('pendingOrdersList');
    el.innerHTML = pending.length ? pending.map(o => `<div class="modal-list-item"><strong>Order #${o.id}</strong> - ${o.trackingStatus}</div>`).join('') : '<p style="text-align:center;color:#888;">No pending orders.</p>';
    document.getElementById('pendingOrdersModal').style.display = 'flex';
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function renderInventory(products) {
    const tbody = document.getElementById('inventory-table-body');
    tbody.innerHTML = '';
    
    products.sort((a, b) => b.id - a.id).forEach(p => {
        const target = p.targetStock || 100;
        const color = p.stockQuantity < (target * 0.10) ? '#e53e3e' : '#2d3748';
        
        const imgSrc = p.imageUrl ? p.imageUrl : 'https://via.placeholder.com/40';
        const imgCell = `
            <div style="display:flex; align-items:center; gap:8px;">
                <img src="${imgSrc}" style="width:36px; height:36px; object-fit:cover; border-radius:6px; border:1px solid #e2e8f0;">
                <input type="file" id="img-${p.id}" accept="image/*" style="display:none;" onchange="uploadImage(${p.id})">
                <button class="btn-update" style="background:#718096; padding:4px 8px; font-size:0.75rem;" onclick="document.getElementById('img-${p.id}').click()" title="Upload Image">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        `;

        tbody.innerHTML += `<tr>
            <td>#${p.id}</td>
            <td>${imgCell}</td>
            <td>${p.name}</td><td>$${p.price}</td>
            <td><input type="number" id="avail-${p.id}" value="${p.stockQuantity}" class="qty-input" min="0" style="color:${color}" oninput="validity.valid||(value='');"></td>
            <td><input type="number" id="target-${p.id}" value="${target}" class="qty-input" min="0" oninput="validity.valid||(value='');"></td>
            <td><button class="btn-update" onclick="updateProduct(${p.id})">Save</button></td>
        </tr>`;
    });
}

function uploadImage(id) {
    const fileInput = document.getElementById(`img-${id}`);
    if (fileInput.files.length === 0) return;

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    fetch(`/products/${id}/upload-image`, { 
        method: 'POST', 
        body: formData 
    })
    .then(res => {
        if (res.ok) { 
            showToast("Image Uploaded!"); 
            refreshAll(); 
        } else {
            showToast("Upload failed");
        }
    })
    .catch(err => showToast("Network error"));
}

function renderSales(orders) {
    const tbody = document.getElementById('orders-table-body');
    tbody.innerHTML = '';
    
    const tzoffset = (new Date()).getTimezoneOffset() * 60000;
    const localToday = (new Date(Date.now() - tzoffset)).toISOString().split('T')[0];

    orders.sort((a,b)=>b.id-a.id).forEach(o => {
        let action = `<span class="status-badge status-${o.trackingStatus}">${o.trackingStatus}</span>`;
        if (o.trackingStatus === 'Ordered') action = `<button class="btn-update" onclick="updateOrder(${o.id},'Shipped')">Ship</button>`;
        else if (o.trackingStatus === 'Shipped') action = `<button class="btn-update" style="background:#4299e1;" onclick="updateOrder(${o.id},'Delivered')">Deliver In Progress</button>`;
        else if (o.trackingStatus === 'Delivered') {
            action = `<a href="/orders/${o.id}/invoice" target="_blank" style="text-decoration:none;">
                        <button class="btn-update" style="background:#718096; display:flex; align-items:center; gap:5px;"><i class="fas fa-print"></i> Invoice</button>
                      </a>`;
        }

        const ordDateStr = o.orderDate ? o.orderDate.split('T')[0] : 'N/A';
        const dateInput = `
            <div style="font-size: 0.72rem; color: #a0aec0; margin-bottom: 3px; font-weight: 600;">Ord: ${ordDateStr}</div>
            <input type="date" id="date-${o.id}" min="${localToday}" value="${o.deliveryDate ? o.deliveryDate.split('T')[0] : ''}" style="padding:4px;border:1px solid #e2e8f0;border-radius:4px; width: 110px;" ${o.trackingStatus!=='Ordered'?'disabled':''}>
        `;
        
        const customerName = o.customer?.fullName || o.customer?.username || 'Guest';

        const orderDetails = (o.items || []).map(i => {
            const prodName = i.product ? i.product.name : 'Unknown Product';
            return `${prodName} [${i.quantity}]`;
        }).join('<br>');

        tbody.innerHTML += `<tr><td>#${o.id}</td><td>${customerName}</td><td>${orderDetails || '-'}</td><td>$${o.totalAmount}</td>
        <td><span class="status-badge status-${o.trackingStatus}">${o.trackingStatus}</span></td><td>${dateInput}</td><td>${action}</td></tr>`;
    });
}

function renderRequests(orders) {
    const tbody = document.getElementById('requests-table-body');
    tbody.innerHTML = '';
    orders.filter(o=>o.trackingStatus==='Return Requested').forEach(o => {
        tbody.innerHTML += `<tr><td>#${o.id}</td><td style="color:#e53e3e;">"${o.returnReason}"</td><td><button class="btn-update" style="background:#48bb78;" onclick="approveReturn(${o.id})">Refund</button></td></tr>`;
    });
}

function renderStaff(staff) {
    const tbody = document.getElementById('staff-table-body');
    tbody.innerHTML = '';
    
    staff.sort((a, b) => a.id - b.id).forEach((s, index) => {
        const isBoss = index === 0;
        let actionHtml = '';

        if (isBoss) {
            actionHtml = `<span style="color:#718096; font-size:0.8rem; font-weight:600;">Primary Admin</span>`;
        } else {
            actionHtml = `<button class="btn-update" style="background:#e53e3e; padding: 6px 10px;" onclick="removeStaff(${s.id})">
                            <i class="fas fa-trash"></i> Remove
                          </button>`;
        }

        tbody.innerHTML += `<tr>
            <td>#${s.id}</td>
            <td><strong>${s.fullName || 'No Name'}</strong></td>
            <td>${s.username}</td>
            <td><span class="status-badge" style="background:#eebefa; color:#6b46c1;">${s.role}</span></td>
            <td>${actionHtml}</td>
        </tr>`;
    });
}

function removeStaff(id) {
    if(!confirm("Are you sure you want to remove this staff member? This cannot be undone.")) return;
    
    fetch(`/api/users/staff/${id}`, {
        method: 'DELETE'
    })
    .then(async res => {
        const msg = await res.text();
        if (res.ok) {
            showToast(msg);
            refreshAll(); 
        } else {
            showToast(msg);
        }
    })
    .catch(err => showToast("Network error occurred"));
}

function updateProduct(id) {
    const avail = document.getElementById(`avail-${id}`).value;
    const target = document.getElementById(`target-${id}`).value;
    if(avail<0 || target<0) return showToast("No negative numbers");
    fetch(`/products/${id}/stock?quantity=${avail}&target=${target}`,{method:'PUT'}).then(res => { if(res.ok) { showToast(`Product #${id} Saved!`); refreshAll(); } else showToast("Update failed"); });
}

function updateOrder(id, s) {
    let url = `/orders/${id}/update-tracking?status=${s}`;
    if(s==='Shipped') {
        const d = document.getElementById(`date-${id}`).value;
        if(!d) return alert("Select Date to Ship Order");
        url += `&date=${d}`;
    }
    fetch(url,{method:'POST'}).then(()=>{ if(s !== 'Delivered') showToast(`Order #${id} → ${s}`); refreshAll(); });
}
function approveReturn(id) { fetch(`/orders/${id}/approve-return`,{method:'POST'}).then(()=>{ showToast("Refund Approved"); refreshAll(); }); }

function switchView(v,e) {
    document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
    document.getElementById(v+'-view').classList.add('active');
    document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
    
    if(e) e.classList.add('active'); 
    else if(v==='sales') document.getElementById('menu-sales').classList.add('active');
    
    const searchBar = document.getElementById('topSearchBar');
    if (searchBar) {
        searchBar.style.visibility = (v === 'dashboard') ? 'hidden' : 'visible';
    }
    
    handleSearch();
}

function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className='show'; setTimeout(()=>t.className='',3000); }

function submitPasswordChange(event) {
    event.preventDefault();
    const oldPass = document.getElementById('old-pwd').value;
    const newPass = document.getElementById('new-pwd').value;

    fetch('/api/user/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
    })
    .then(async res => {
        const msg = await res.text();
        if (res.ok) {
            showToast(msg);
            closeModal('passwordModal');
            document.getElementById('passwordForm').reset();
        } else {
            showToast("Error: " + msg);
        }
    })
    .catch(err => showToast("Network error occurred"));
}

function submitAdminName(event) {
    event.preventDefault();
    const newName = document.getElementById('new-admin-name').value;

    fetch('/api/user/update-name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newName: newName })
    })
    .then(async res => {
        if (res.ok) {
            document.getElementById('display-admin-name').innerText = newName;
            showToast("Admin Name Saved to Database!");
            closeModal('nameModal');
        } else {
            showToast("Error saving name.");
        }
    })
    .catch(err => showToast("Network error"));
}

function submitNewStaff(event) {
    event.preventDefault();
    const requestData = {
        fullName: document.getElementById('staff-name').value,
        username: document.getElementById('staff-user').value,
        password: document.getElementById('staff-pass').value
    };

    fetch('/api/users/add-staff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(async res => {
        const msg = await res.text();
        if (res.ok) {
            showToast(msg);
            closeModal('addStaffModal');
            document.getElementById('addStaffForm').reset();
            refreshAll(); 
        } else {
            showToast("Error: " + msg);
        }
    })
    .catch(err => showToast("Network error occurred"));
}
</script>
</body>
</html>